---
title: "Predict Departure Delay"
author: "Nils Hellwig"
date: "24 5 2023"
output: html_document
---

# Load Packages

```{r}
library(ggplot2)
library(dplyr)
library(stringr)
library(caret)
```

# Load Datasets

First, we need to load the dataset and add some columns that will be used for feature extraction (as already known from the data exploration script).

```{r}
# Load departure data
departure_data <- read.csv("datasets/departure_dataset.csv")
weather_data <- read.csv("datasets/weather_munich_dataset.csv")
```

```{r}
departure_data$departure_scheduled_datetime_local <- as.POSIXct(departure_data$departure_scheduled_datetime_local)
weather_data$six_hours_starting_from_datatime <- as.POSIXct(paste(weather_data$date, weather_data$six_hours_starting_from))
```

```{r}
get_weather_data <- function(departure_time) {
  if (format(departure_time, format = "%Y-%m-%d 06:00:00") > departure_time) {
    weather_span <- format(departure_time, format = "%Y-%m-%d 00:00:00")
  } else if (format(departure_time, format = "%Y-%m-%d 12:00:00") > departure_time) {
    weather_span <- format(departure_time, format = "%Y-%m-%d 06:00:00")
  } else if (format(departure_time, format = "%Y-%m-%d 18:00:00") > departure_time) {
    weather_span <- format(departure_time, format = "%Y-%m-%d 12:00:00")
  } else if (format(departure_time, format = "%Y-%m-%d 24:00:00") > departure_time) {
    weather_span <- format(departure_time, format = "%Y-%m-%d 18:00:00")
  } 
  nearest_row <- weather_data[weather_data$six_hours_starting_from_datatime == weather_span,]
  return(weather_span)
}

departure_data$six_hours_starting_from_datatime <- as.POSIXct(sapply(departure_data$departure_scheduled_datetime_local, get_weather_data))
# exclude unnecessary columns that we don't want to add to the departure_data dataframe
merge_cols_weather_data <- setdiff(names(weather_data), c("date", "six_hours_starting_from"))
departure_data <- merge(departure_data, weather_data[, c(merge_cols_weather_data)], by.x = "six_hours_starting_from_datatime", by.y = "six_hours_starting_from_datatime", all.x = TRUE)
# For a better understanding of what data is in this column
departure_data <- departure_data %>%
  rename(weather_description = description)
```

As I want to predict the amount of delay, I will only look at flights that have landed

```{r}
departure_data <- departure_data[departure_data$flight_status == "Landed", ]
departure_data
```

# ------ Feature Coding --------

```{r}
dataset <- departure_data %>%
  select(departure_scheduled_datetime_local,
         delay_departure_min,
         departure_scheduled_weekday_local,
         departure_scheduled_hour_local, # continuous variable
         departure_scheduled_month_local, # continuous variable 
         departure_scheduled_year_local, # continuous variable
         temperature_celsius)
```

```{r}
dataset$departure_scheduled_weekday_local <- as.numeric(factor(dataset$departure_scheduled_weekday_local,
                                                                      levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"),
                                                                      labels = 1:7))
```

```{r}
# There are cases where no weather description is given but other weather data such as temperature is available. 
# In this case, I set a value for these cases so that the value is not NA but such cases get their own column for the one-hot encoding.
departure_data$weather_description <- ifelse(is.na(departure_data$weather_description), "Not specified", departure_data$weather_description)
```

```{r}
dataset <- cbind(dataset, model.matrix(~ airline_name - 1, data = departure_data))
dataset <- cbind(dataset, model.matrix(~ destination_IATA - 1, data = departure_data))
dataset <- cbind(dataset, model.matrix(~ weather_description - 1, data = departure_data))
dataset
```

Remove Outliers

```{r}
z_scores <- scale(dataset$delay_departure_min)
z_threshold <- 3
outliers_train_df <- abs(z_scores) > z_threshold
dataset <- dataset[!outliers_train_df, ]
```

# To-Do: Schauen was man macht, wenn ein Wert fehlt (Celsius!)
# To-Do woche diskret?
# To-Do: Luftdruck?
# To-Do: Delay als Spalte

# ------ Split Dataset to train/test --------

Split Dataset

```{r}
scheduled_departure_dates <- as.Date(dataset$departure_scheduled_datetime_local)
train_df <- subset(dataset, scheduled_departure_dates < max(scheduled_departure_dates) - 365)
test_df <- subset(dataset, scheduled_departure_dates >= max(scheduled_departure_dates) - 365)
```

Add temperature

```{r}
average_temperature_train <- mean(train_df$temperature, na.rm = TRUE)
average_temperature_test <- mean(test_df$temperature, na.rm = TRUE)
train_df$temperature <- ifelse(is.na(train_df$temperature), average_temperature_train, train_df$temperature)
test_df$temperature <- ifelse(is.na(test_df$temperature), average_temperature_test, test_df$temperature)
```

```{r}
category_quantiles <- quantile(train_df$delay_departure_min, probs = c(0.0, 0.2, 0.4, 0.6, 0.8, 1.0))
category_quantiles
```

```{r}
train_df$delay_departure_min_category <- cut(train_df$delay_departure_min, 
                                             breaks = category_quantiles, 
                                             labels = c("on time or earlier", "short delay", "medium delay", "longer delay", "very long delay"),
                                             include.lowest = TRUE)
```

```{r}
train_df[train_df$delay_departure_min == 3,][, c("delay_departure_min_category", "delay_departure_min")]
```
```{r}
train_df
```
```{r}
# Set seed for reproducibility
set.seed(42)

# Define train control
ctrl <- trainControl(method = "cv",   
                     number = 5)      

model <- train(delay_departure_min_category ~ .,   
               data = train_df,                     
               method = "rf")                       
               #,trControl = ctrl)                     

print(model)
```

