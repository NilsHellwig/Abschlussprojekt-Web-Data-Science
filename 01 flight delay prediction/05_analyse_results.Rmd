# Notebook: Analyse Results of Trained Model

## Load Packages

```{r}
library(ggplot2)
library(dplyr)
library(tidyverse)
```

## Define Settings

```{r}
top_n <- 7
model_name <- "rf"
```

## Code

### Add Column

In order to better visualize the results of the trained model, I will add a column containing both year and month.

```{r}
evaluation_results <- read.csv(paste0("results/results_", model_name, ".csv"))

evaluation_results <- evaluation_results %>%
  mutate(year_month_train = paste(year_start_train, month_start_train, sep = "-"))

evaluation_results[, c("year_month_train", "Accuracy")]
```

### Calculate mean of each column

I want to calculate the mean of each metric based on all months for which I trained the model.

```{r}
metrics_df <- evaluation_results[, 6:23]

metrics <- data.frame(
  Mean = apply(metrics_df, 2, mean, na.rm = TRUE),
  Median = apply(metrics_df, 2, median, na.rm = TRUE),
  Min = apply(metrics_df, 2, min, na.rm = TRUE),
  Max = apply(metrics_df, 2, max, na.rm = TRUE),
  Q1 = apply(metrics_df, 2, quantile, probs = 0.25, na.rm = TRUE),
  Q3 = apply(metrics_df, 2, quantile, probs = 0.75, na.rm = TRUE)
)

row.names(metrics) <- colnames(metrics_df)
metrics
```

###  Get Most Important Features

I want to get the features that have the highest average variable importance

```{r}
feature_columns <- evaluation_results[, 24:ncol(evaluation_results)]
head(feature_columns)
```

```{r}
column_means <- sapply(feature_columns, mean)
sorted_means <- sort(column_means, decreasing = TRUE)
top_n_columns <- names(sorted_means)[1:top_n]
head(top_n_columns)
```


### Format Data for Visualisation of the Development of the Feature Importance Over Time

```{r}
selected_feature_timeseries <- evaluation_results %>%
  select(all_of(top_n_columns), year_month_train)
selected_feature_timeseries <- tidyr::gather(selected_feature_timeseries, key = "feature", value = "importance", -year_month_train)
selected_feature_timeseries$year_month_train <- as.Date(paste0(selected_feature_timeseries$year_month_train, "-01"))
head(selected_feature_timeseries)
```

### Create Visualisation for each Year

To visualise the development of the feature importance over time, I create a dataframe with three columns, one with the month/year of the test data that should be evaluated, the airline and the importance of the feature.

```{r, fig.width = 10, fig.height= 3}
x_labels <- unique(selected_feature_timeseries$year_month_train)

for (year in unique(year(selected_feature_timeseries$year_month_train))) {
  year_data <- subset(selected_feature_timeseries, year(selected_feature_timeseries$year_month_train) == year)
  plot <- ggplot(year_data, aes(x = year_month_train, y = importance, color = feature)) +
    geom_line() +
    labs(x = "Month", y = "Variable Importance", color = "Feature") +
    scale_x_date(breaks = x_labels, labels = format(x_labels, "%b %Y")) +
    ggtitle(paste("Year", year))
  
  filename <- paste0("plots/", "plot_", model_name, "_", year, ".png", sep = "")
  ggsave(filename, plot = plot, width = 20, height = 10, dpi = 300)
  print(plot) 
}
```
