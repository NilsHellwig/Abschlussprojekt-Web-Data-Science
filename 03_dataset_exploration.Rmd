---
title: "Dataset Exploration"
author: "Nils Hellwig"
date: "24 5 2023"
output: html_document
---

In order to gain a better understanding of what the data collected looks like, important characteristics of the dataset will be presented/visualised.

# Load Packages

```{r}
library(ggplot2)
library(dplyr)
```


# Load Datasets

First, we need to load the dataset

```{r}
# Load departure data
departure_data <- read.csv("datasets/departure_dataset.csv")
departure_data$date_departure <- as.Date(departure_data$date_departure)
departure_data$planned_departure_month_year <- format(departure_data$date_departure, "%Y-%m")
departure_data$planned_departure_month <- format(departure_data$date_departure, "%m")
departure_data$planned_departure_year <- format(departure_data$date_departure, "%Y")
Sys.setlocale("LC_TIME", "C")
weekday_order <- c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")
departure_data$planned_departure_weekday <- factor(weekdays(departure_data$date_departure), levels = weekday_order)
departure_data$departure_scheduled_time_local_hour <- format(as.POSIXct(departure_data$departure_scheduled_time_local, format = "%H:%M"), format = "%H")

# Load weather data
weather_data <- read.csv("datasets/weather_munich_dataset.csv")
```


```{r}
weather_data$datetime <- as.POSIXct(paste(weather_data$date, weather_data$six_hours_starting_from))
departure_data$departure_scheduled_utc_time <- as.POSIXct(departure_data$departure_scheduled_utc_time, format = "%H:%M")
departure_data$departure_datetime <- as.POSIXct(paste(departure_data$date_departure, format(departure_data$departure_scheduled_utc_time, "%H:%M")), format = "%Y-%m-%d %H:%M")
```

```{r}
get_weather_data <- function(departure_time) {
  weather_data$diff <- abs(weather_data$datetime - departure_time)
  nearest_row <- weather_data[which.min(weather_data$diff), ]
  return(nearest_row$description[1])
}

departure_data$weather_description <- sapply(departure_data$departure_datetime, get_weather_data)
```

Let's have a look to our data...

```{r}
departure_data
```

# Explore Departure Data in General

In a first step, we can explore our dataset and its characteristics. 
It is always important to note that our dataset is only a sample. For each day between 18.09.2017 and 15.05.2023 flights that took off/landed in Munich were collected by flightera.org, whereby the flights were only collected for two random hours of each day (see 01_... notebooks).
Now, we can have a look at how many flights have landed, were diverted etc. (occurrences of the various flight statuses)

```{r}
table(departure_data$flight_status)
```

Due to the Covid-19 pandemic, strong differences between the years can be observed here.

```{r, fig.width = 10, fig.height = 20}
flight_status_count <- departure_data %>%
  group_by(planned_departure_year, planned_departure_month, flight_status) %>%
  summarise(count = n())

ggplot(flight_status_count, aes(x = planned_departure_month, y = count, fill = flight_status)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~planned_departure_year, ncol = 1) +
  xlab("Month") +
  ylab("# Flights") +
  ggtitle("Distribution of Flight Status by Month (Year-wise)")

```

Next, we can look at how many flights were *planned* to took off from Munich Airport in the period for which the data was collected for.
Here it can be seen that in 2020, the year that was strongly influenced by the pandemic, there was a decrease in flights.

```{r}
# Let's only consider the months for which data is available for each day in that month. 
flight_count_departure <- departure_data[!(format(departure_data$date_departure, "%Y-%m") %in% c("2017-09", "2023-05")), ] %>%
  group_by(planned_departure_month_year) %>%
  summarise(count = n())

ggplot(flight_count_departure, aes(x = as.Date(paste(planned_departure_month_year, "01", sep = "-")), y = count)) +
  geom_line() +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 year") +
  labs(x = "Month", y = "# Flights") +
  ggtitle("Departures from Munich Airport")
```

Next, we can look at which airline's flights are most frequently scheduled to take off from Munich.

```{r}
airlines <- departure_data %>%
  group_by(airline_name) %>%
  summarise(count = n()) %>%
  arrange(-count)

airlines
```

Of course, this can also be displayed in a bar chart with the percentage share of each airline in the overall dataset ;)

```{r}
top_20_airlines_departure <- departure_data %>%
  count(airline_name) %>%
  mutate(percentage = (n / nrow(departure_data)) * 100) %>%
  arrange(-percentage) %>%
  head(20)

ggplot(top_20_airlines_departure, aes(x = reorder(airline_name, -percentage), y = percentage)) +
  geom_bar(stat = "identity", fill = "orange") +
  labs(x = "Airline", y = "% of all collected Flights", title = "Most frequent airlines departing from Munich Airport") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Finally, you can also take a look at the airports to which there are the most frequent flights from Munich.

```{r}
destinations <- departure_data %>%
  group_by(destination_IATA, destination_name) %>%
  summarise(count = n()) %>%
  arrange(-count)

destinations
```

```{r}
top_20_destinations_departure <- departure_data %>%
  count(destination_country) %>%
  mutate(percentage = (n / nrow(departure_data)) * 100) %>%
  arrange(-percentage) %>%
  head(20)

ggplot(top_20_destinations_departure, aes(x = reorder(destination_country, -percentage), y = percentage)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Destination (Country)", y = "% of all collected Flights", title = "Most frequent destinations from Munich Airport") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# ------ Feature Exploration --------
# Analyse Delay of departure from Munich airport


Next, we can examine how often and how much delayed flights are taking off from Munich. To analyse delays, we only look at flights that have landed and not flights that have been cancelled, diverted or whose status is unknown etc.. We also need to remove outliers. There seem to be flights with extreme delays, which probably does not correspond to reality but is an error.

```{r}
delay_departure_data <- departure_data[departure_data$flight_status == "Landed" & departure_data$delay_departure_min <= 1440 & departure_data$delay_departure_min >= -200, ]

# Let's only consider the months for which data is available for each day. 
delay_departure_data <- delay_departure_data[!(format(delay_departure_data$date_departure, "%Y-%m") %in% c("2017-09", "2023-05")), ]
```

Next, we can look at how often flights have taken off late, early or on time.

```{r}
# Let's have a look to how many flights are delayed of those which landed successfully
delay_departure_data$delay_departure <- ifelse(delay_departure_data$delay_departure_min > 0, "delayed",
                                         ifelse(delay_departure_data$delay_departure_min < 0, "landed earlier",
                                                "on time"))
print(table(delay_departure_data$delay_departure))
#delay_departure_data <- delay_departure_data[delay_departure_data$delay_departure == "delayed",]
```

We can also look how many minutes on average the deviation from the planned depature time is.

```{r}
summary(delay_departure_data$delay_departure_min)
```

Looking at the average number of minutes of delay for all months, it is noticeable that in the years that were heavily affected by the Covid 19 pandemic (2020 and 2021), the number of minutes of delay was lower than before and after that time.

```{r}
average_delay_destination_departures <- delay_departure_data %>%
  group_by(planned_departure_month_year) %>%
  summarise(avg_delay = mean(delay_departure_min))

ggplot(average_delay_destination_departures, aes(x = as.Date(paste(planned_departure_month_year, "01", sep = "-")), y = avg_delay)) +
  geom_bar(stat = "identity", fill = "blue") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 year") +
  labs(x = "Month", y = "Average Delay (Departure) in Minutes") +
  ggtitle("Departures from Munich Airport")
```

There also seems to be a difference in how much the average delay is depending on the month.

```{r}
ggplot(delay_departure_data, aes(x = planned_departure_month, y = delay_departure_min)) +
  geom_boxplot() +
  labs(x = "Month", y = "Delay (Minutes)", title = "Distribution of Delay per Month") +
  coord_cartesian(ylim = c(0, 100))
```

This trend can also be seen if one excludes the two years 2020 and 2021, which were heavily affected by the pandemic.

```{r}
years_no_pandemic <- c(2017, 2018, 2019, 2020, 2023)

ggplot(delay_departure_data %>% filter(planned_departure_year %in% years_no_pandemic), aes(x = planned_departure_month, y = delay_departure_min)) +
  geom_boxplot() +
  labs(x = "Month", y = "Delay (Minutes)", title = "Distribution of Delay per Month [without 2020 and 2021]") +
  coord_cartesian(ylim = c(0, 100))

```
Furthermore, there also seems to be differences depending on the time of day (hour of the day) as to how severe the delay of the departure of flights is. 

```{r}
ggplot(delay_departure_data, aes(x = departure_scheduled_time_local_hour, y = delay_departure_min)) +
  geom_boxplot() +
  labs(x = "Hour", y = "Delay (Minutes)", title = "Distribution of delay at different times of the day") +
  coord_cartesian(ylim = c(0, 50))
```

```{r}
delay_departure_data
```


```{r}
ggplot(delay_departure_data, aes(x = planned_departure_weekday, y = delay_departure_min)) +
  geom_boxplot() +
  labs(x = "Weekday", y = "Delay (Minutes)", title = "Distribution of delay at different weekdays") +
  coord_cartesian(ylim = c(0, 50))
```

There also seem to be differences between the airlines as to how long the delay is. For this we can look at the airlines that have at least one flight a day on average. 

```{r}
top_airlines_delay <- delay_departure_data %>%
  group_by(airline_name, airline_country) %>%
  summarise(delay_mean = mean(delay_departure_min), delay_median = median(delay_departure_min), count = n()) %>%
  filter(count >= 365) %>%
  arrange(-delay_mean)

top_airlines_delay
```

Next, we can look at whether the destination has an influence. If we look again at destinations that are flown to at least once a day on average, we can see that there are differences.

```{r}
top_destination_delay <- delay_departure_data %>%
  group_by(destination_IATA, destination_name) %>%
  summarise(delay_mean = mean(delay_departure_min), delay_median = median(delay_departure_min), count = n()) %>%
  filter(count >= 365) %>%
  arrange(-delay_mean)

top_destination_delay
```

Last, let's have a look at how the weather might have an influence on delays...

```{r}
top_weather_delay <- delay_departure_data %>%
  group_by(weather_description) %>%
  summarise(delay_mean = mean(delay_departure_min), delay_median = median(delay_departure_min), count = n()) %>%
  #filter(count >= 365) %>%
  arrange(-delay_mean)

top_weather_delay
```

```{r}
delay_departure_data
```


Featured explored:

* Destination
* Airline
* Hour of the day
* Month
* Weekday?
* Weather

```{r}
# Verspätung je Monat
# Delay Ankunft
# Signifikanztests
# wie viele Airlines / wie viele Ziele
# Wie viele Flüge gecancelt / etc in Plot darstellen
# Problem: Manchmal wird für weitere Studien gecrawlt
# Schauen ob bei bestimmtem Wetter häufiger mehr Verspätung
# Verspätung nach Jahr
# planned_departure_year umbenennen auch andere variablen
```

